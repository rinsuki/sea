name: Build and Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOCKER_NAME: docker.pkg.github.com/rinsuki/sea/sea-app
    steps:
      - uses: actions/checkout@master
      - name: Launch PostgreSQL Container
        run: |
          docker run --name postgres -e POSTGRES_PASSWORD=onlyfortesting -d postgres:10-alpine
      - name: Build docker container
        run: |
          docker build -t $DOCKER_NAME:latest .
      - name: Run migration
        run: |
          docker run --rm --link postgres:postgres -e DATABASE_URL="postgres://postgres:onlyfortesting@postgres/postgres" $DOCKER_NAME yarn migration:up
      - name: Run test
        run: |
          docker run --rm --link postgres:postgres --env-file ./ci-files/.env -e DATABASE_URL="postgres://postgres:onlyfortesting@postgres/postgres" -v $(pwd)/coverage:/app/coverage $DOCKER_NAME sh -c 'yarn test --coverage --coverageReporters=cobertura --coverageReporters=html'
      - name: Upload docker container
        run: |
          docker login docker.pkg.github.com --username rinsuki --password ${{ secrets.GITHUB_TOKEN }}
          docker push $DOCKER_NAME:latest
          docker logout docker.pkg.github.com
      - name: Prepare for Publish code coverage
        run: |
          sudo chown $(whoami) ./coverage/cobertura-coverage.xml
          python3 -c 'import os;r=open("./coverage/cobertura-coverage.xml", "r").read().replace("/app", os.getcwd());open("./coverage/cobertura-coverage.xml", "w").write(r)'
      - name: Upload Code Coverage to codecov
        uses: codecov/codecov-action@v1.0.3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/cobertura-coverage.xml
